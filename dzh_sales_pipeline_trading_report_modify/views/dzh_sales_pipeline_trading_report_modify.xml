<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <data>
        <!--create header and footer-->
        <template id="external_layout_trading_report">
            <!-- Multicompany -->
            <t t-if="not o and doc">
                <t t-set="o" t-value="doc"/>
            </t>
            <t t-if="o and 'company_id' in o">
                <t t-set="company" t-value="o.company_id"></t>
            </t>
            <t t-if="not o or not 'company_id' in o">
                <t t-set="company" t-value="res_company"></t>
            </t>

            <t t-call="dzh_sales_pipeline_trading_report_modify.external_layout_header_trading_report" />
            <t t-raw="0" />
            <t t-call="dzh_sales_pipeline_trading_report_modify.external_layout_footer_trading_report" />
        </template>

        <template id="dzh_sales_pipeline_trading_report_modify.external_layout_header_trading_report">
            <div class="header">
                <div class="header" style="padding-bottom:0px; margin:0px">
                    <div class="row">
                        <img t-if="company.logo" t-att-src="'data:image/png;base64,%s' % company.logo" style="height:40px;width:160px;float:right"/>
                        <span  class ="text-center" style="font-size: 24px; font-weight:bold">Trading Solutions - Sales Pipeline (Corporate)</span>
                    </div>
                </div>
            </div>
        </template>

        <template id="dzh_sales_pipeline_trading_report_modify.external_layout_footer_trading_report">
            <div class="footer" style="font-size:10pt;">
                <div class="row">
                    <div class="col-xs-12 text-right">
                        <div class="text-right" style="float:right">
                            <ul class="list-inline">
                                <li>Page:</li>
                                <li><span class="page"/></li>
                                <li>of</li>
                                <li><span class="topage"/></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <report
            id="action_pipeline_trading_report"
            model="pipeline.trading.report"
            string="Pipeline Trading Report"
            name="dzh_sales_pipeline_trading_report_modify.pipeline_trading_report"
            file="dzh_sales_pipeline_trading_report_modify.pipeline_trading_report"
            report_type="qweb-pdf"
        />

        <record id="report_pipe_qweb_paperformat" model="report.paperformat">
            <field name="name">Holidays Summary</field>
            <field name="default" eval="True"/>
            <field name="format">custom</field>
            <field name="page_height">297</field>
            <field name="page_width">210</field>
            <field name="orientation">Landscape</field>
            <field name="margin_top">30</field>
            <field name="margin_bottom">23</field>
            <field name="margin_left">5</field>
            <field name="margin_right">5</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">20</field>
            <field name="dpi">90</field>
        </record>

        <record id="action_pipeline_trading_report" model="ir.actions.report.xml">
            <field name="paperformat_id" ref="report_pipe_qweb_paperformat"/>
        </record>
        <!--create report-->
        <template id="dzh_sales_pipeline_trading_report_modify.pipeline_trading_report">
            <t t-call="report.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="dzh_sales_pipeline_trading_report_modify.external_layout_trading_report">
                        <div class="page">
                            <div t-foreach="o.country_ids" t-as="country">
                                <table class="table table-bordered" style="font-size:10px; padding-top:10px; width:100%">
                                    <thead>
                                        <!--get sales person and not duplicate-->
                                        <t t-set="refund_partners" t-value="[]"/>
                                        <t t-foreach="o.pipeline_ids" t-as="refund" t-if="refund.user_id">
                                            <t t-if="refund.partner_id.country_id.id == country.id">
                                                <t t-if="refund.user_id.name not in refund_partners">
                                                    <t t-set="refund_partners" t-value="refund_partners + [refund.user_id.name]"/>
                                                </t>
                                            </t>
                                        </t>
                                        <span style="font-size: 12px;font-weight: bold;" t-field="country.name"/><span>  -  </span>
                                        <span style="font-size: 12px;font-weight: bold;" t-foreach="refund_partners" t-as="partner">
                                            <span t-esc="partner"/> &amp;
                                        </span>
                                        <!--<tr>-->
                                            <!--<td style="background-color: #F0E68C;">ALL</td>-->
                                        <!--</tr>-->
                                        <tr style="background-color: #95b3d7;">
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:13%">Company</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">Country</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">Account Manager</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">Services/Solutions</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:11%">Potential Revenue Monthy</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:11%">Annual Revenue</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">One Time Revenue</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">Start Date/Billing</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:9%">Probability</th>
                                            <th class="text-left" style="background-color:#95b3d7; border:1px solid #BFBFBF; width:11%">Remarks</th>
                                            <!--<th class="text-left" style="background-color:lightgray; border:1px solid #BFBFBF; width:8%">Invoice Number</th>-->
                                            <!--<th class="text-left" style="background-color:lightgray; border:1px solid #BFBFBF; width:8%">Payment Dat Remark</th>-->
                                        </tr>
                                    </thead>
                                    <!--<t t-set="total" t-value="0" />-->
                                    <tbody>
                                        <t t-set="total_planned" t-value="0"/>
                                        <t t-set="annual_planned" t-value="0"/>
                                        <tr>
                                            <td style="background-color:#95b3d7;">Trading (GTS)</td>
                                            <td colspan="9"></td>
                                        </tr>
                                        <tr t-foreach="o.pipeline_ids" t-as="lead">
                                            <t t-if="lead.partner_id.country_id.id == country.id and lead.invoice_type == 'trading_gts'">
                                                <td>
                                                    <span t-field="lead.partner_id"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.partner_id.country_id.name"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.user_id"/>
                                                </td>
                                                <td>
                                                    <p t-foreach="lead.partner_id and lead.partner_id.opportunity_ids" t-as="op">
                                                        <span t-field="op.name"></span>
                                                    </p>
                                                </td>
                                                <td>
                                                    <span t-field="lead.planned_revenue"/>
                                                    <t t-set="total_planned" t-value="total_planned + lead.planned_revenue"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.annual_revenue"/>
                                                    <t t-set="annual_planned" t-value="annual_planned + lead.annual_revenue"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.one_time_revenue"/>
                                                </td>
                                                <td>
                                                    <span style="white-space:nowrap;" t-field="lead.x_subscription_period" t-field-options="{&quot;format&quot;: &quot;d-MMM-yy&quot;}"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.probability"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.description"/>
                                                </td>
                                            </t>
                                        </tr>
                                        <tr style="page-break-inside:avoid;background-color:#00b0f0;">
                                            <td colspan="3">
                                                <span t-esc="o.date_filter[0]"></span>
                                            </td>
                                            <td>
                                                <!--<span t-esc="o.pipeline_ids[0][f]['currency']"></span>-->
                                            </td>
                                            <td>
                                                <span>$ </span><span t-esc="'{0:,.2f}'.format(int(total_planned))"></span>
                                            </td>
                                            <td>
                                                <span>$ </span><span t-esc="'{0:,.2f}'.format(int(annual_planned))"></span>
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td></td>
                                        </tr>
                                        <t t-set="total_planned" t-value="0"/>
                                        <t t-set="annual_planned" t-value="0"/>
                                        <tr>
                                            <td style="background-color:#95b3d7;">Trading (DZHI)</td>
                                            <td colspan="9"></td>
                                        </tr>
                                        <tr t-foreach="o.pipeline_ids" t-as="lead">
                                            <t t-if="lead.partner_id.country_id.id == country.id and lead.invoice_type == 'trading_dzh'">
                                                <td>
                                                    <span t-field="lead.partner_id"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.partner_id.country_id.name"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.user_id"/>
                                                </td>
                                                <td>
                                                    <p t-foreach="lead.partner_id and lead.partner_id.opportunity_ids" t-as="op">
                                                        <span t-field="op.name"></span>
                                                    </p>
                                                </td>
                                                <td>
                                                    <span t-field="lead.planned_revenue"/>
                                                    <t t-set="total_planned" t-value="total_planned + lead.planned_revenue"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.annual_revenue"/>
                                                    <t t-set="annual_planned" t-value="annual_planned + lead.annual_revenue"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.one_time_revenue"/>
                                                </td>
                                                <td>
                                                    <span style="white-space:nowrap;" t-field="lead.x_subscription_period" t-field-options="{&quot;format&quot;: &quot;d-MMM-yy&quot;}"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.probability"/>
                                                </td>
                                                <td>
                                                    <span t-field="lead.description"/>
                                                </td>
                                            </t>
                                        </tr>
                                        <tr style="page-break-inside:avoid;background-color:#00b0f0;">
                                            <td colspan="3">
                                                <span t-esc="o.date_filter[0]"></span>
                                            </td>
                                            <td>
                                                <!--<span t-esc="o.pipeline_ids[0][f]['currency']"></span>-->
                                            </td>
                                            <td>
                                                <span>$ </span><span t-esc="'{0:,.2f}'.format(int(total_planned))"></span>
                                            </td>
                                            <td>
                                                <span>$ </span><span t-esc="'{0:,.2f}'.format(int(annual_planned))"></span>
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td>
                                                <!--<span>SGD</span>-->
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>
                </t>
            </t>
        </template>

        <record id="view_pipeline_trading_report" model="ir.ui.view">
            <field name="name">pipeline.trading.report.form</field>
            <field name="model">pipeline.trading.report</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
		        <form string="Sales Pipeline Trading Report" version="10.0" style="height:240px">

		            	<group>
		            		<group>
		            			<field name="country_id" string="Country"/>
                                <field name="start_date" string="Start Date" required="1"/>
		            		</group>
		            		<group>
		            			<field name="user_id" string="Sales Person"/>
                                <field name="end_date" string="End Date" required="1"/>
		            		</group>
		        		</group>

		            <footer>
						<button string="Print" name="print_trading_report" type="object" class="oe_highlight"/>
		                or
		                <button string="Cancel" class="oe_link" special="cancel" />
		            </footer>
		        </form>
            </field>
        </record>

        <record id="action_pipeline_trading_report" model="ir.actions.act_window">
            <field name="name">Sales DZH Trading Report</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">pipeline.trading.report</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
        </record>

        <menuitem
            id="pipeline_trading_report_menu"
            name="Pipeline Trading Report"
            parent="sales_team.menu_sale_report"
            action="action_pipeline_trading_report"
        />
    </data>
</odoo>